#! /home/amancinelli/CBQN/BQN

âŸ¨feâŸ©â‡

âŸ¨nl, alnum, alpha, syms, digits, tâŸ©â†â€¢Import "util.bqn"

# Front end namespace
fe â† {
  toks â‡ âŸ¨âŸ©
  src â† @ # source text
  DumpToks â‡ {ğ•Š:
    â€¢Out "
============================================
            Dump of Token Table
============================================
"
    il â† 2
    Inâ†{' 'Â¨â†•ğ•©}
    (1âŠ¸âŠ‘)â—¶âŸ¨
      {ğ•Š:â€¢Out (In il)âˆ¾"("â‹„il+â†©2}, # lparen
      {ğ•Š:il-â†©2â‹„â€¢Out (In il)âˆ¾")"}, # rparen
      {â€¢Out (In il)âˆ¾"id: "âˆ¾(â€¢Fmt 2âŠ‘ğ•©)}, # ID
      {â€¢Out (In il)âˆ¾"num: "âˆ¾(â€¢Fmt 2âŠ‘ğ•©)}, # number
    âŸ©Â¨toks
  }
  Tokenize â‡ {ğ•Š:

      s â† src â†© ğ•©
      lpm â† '(' = s
      rpm â† ')' = s
      ws â† ' ' = s

      "parens not balanced" ! 0=+Â´(lpm-rpm)

      lâ€¿r â† 1â†“âŠ”(lpmâˆ¨(2Ã—rpm)) # get indices for left/right parens
      lâ†©{ğ•©â€¿t.lp}Â¨lâ‹„râ†©{ğ•©â€¿t.rp}Â¨r
      toks â†© lâˆ¾r

      # Find IDs and numbers, break into index-value pairs
      alnumm â† âˆŠâŸœ(symsâˆ¾alnum) s
      alnumStrings â† alnumm ((Â¬-ËœâŠ¢Ã—Â·+`Â»âŠ¸>)âŠ¸âŠ”) s
      alnumStarts â† 1âŠ‘âŠ”{ğ•Š0â€¿1:1;0}Â¨<Ë˜2â†•0âˆ¾alnumm

      # Convert to real IDs and numeric literals. If the first value of the id/numlit
      # is a digit, assume the whole thing is a digit. we'll do error checking later.
      indexTypeValueTuples â† {ğ•Šiâ€¿v:
        iâ€¿((âŠ‘(alphaâˆ¾syms)âˆŠËœâŠ‘v)âŠ‘âŸ¨t.num,t.idâŸ©)â€¿v
      }Â¨<Ë˜â‰alnumStartsâ‰alnumStrings

      toks âˆ¾â†© indexTypeValueTuples

      # Sort according to source location
      toks â†© (âŠ‘Â¨toks)â‹âŠ¸âŠtoks
  }
}
